<template>
  <router-link to="/">HOME</router-link>
  <v-container class="h-[100vh] flex">
    <v-row justify="center" align="center">
      <v-col cols="12">
        <v-card>
          <v-card-title class="headline">Cadastro de Usuário</v-card-title>
          <v-card-text>
            <v-form @submit.prevent="register">
              <v-text-field v-model="userData.email" label="Email" type="email" required></v-text-field>
              <v-text-field v-model="userData.password" label="Senha" type="password" required></v-text-field>
              <v-text-field v-model="userData.confirmPassword" label="Confirmar Senha" type="password"
                required></v-text-field>
              <v-text-field v-model="userData.name" label="Nome" required></v-text-field>
              <v-text-field v-model="userData.cpf" label="CPF" required></v-text-field>
              <v-menu v-model="menu" :close-on-content-click="false" :nudge-right="40" transition="scale-transition">
                <v-text-field v-model="userData.birthDate" label="Data de Nascimento" readonly required></v-text-field>
                <v-date-picker v-model="userData.birthDate" @input="menu = false"></v-date-picker>
              </v-menu>
              <v-file-input label="Foto" accept="image/*"></v-file-input>
              <v-btn type="submit" color="primary">Cadastrar</v-btn>
              <p class="error-message">{{ errorMessage }}</p>
            </v-form>
          </v-card-text>
        </v-card>
      </v-col>
    </v-row>
  </v-container>
</template>

<script setup lang="ts">
import { ref } from "vue";
import { getAuth, createUserWithEmailAndPassword } from "firebase/auth";
import { getFirestore, collection, addDoc, Timestamp } from "firebase/firestore";
// import { useRouter } from "vue-router";
import { UserData } from "../models/UserData";

const userData: UserData = ref({
  email: "",
  name: "",
  cpf: "",
  birthDate: "",
  password: "",
  confirmPassword: "",
  photo: null,
});
const errorMessage = ref("");
const menu = ref(false);
// const router = useRouter();

const register = async () => {
  try {
    // Verificar se as senhas coincidem
    if (userData.password !== userData.confirmPassword) {
      throw new Error("As senhas não coincidem");
    }

    // Registrar usuário no Firebase Authentication
    const userCredential = await createUserWithEmailAndPassword(getAuth(), userData.email, userData.password);
    const user = userCredential.user;

    // Adicionar dados do usuário ao Firestore
    const db = getFirestore();
    await addDoc(collection(db, "users"), {
      userId: user.uid,
      email: userData.email,
      name: userData.name,
      cpf: userData.cpf,
      birthDate: userData.birthDate,
      createdAt: Timestamp.now()
    });

    // Redirecionar para a página de login após o registro
    // router.push("/login");
  } catch (error: any) {
    console.error("Erro ao registrar usuário:", error.message);
    errorMessage.value = error.message;
  }
};
</script>
